{% extends '_layouts/base.html' %}
{% set title = "Ionic - Login" %}
{% set id = "login" %}
{% set pre_footer = false %}
{% set header_style = 'transparent light' %}
{% set meta_description = "Log in to Ionic." %}
{% set stickyNav = false %}

{% block main %}
<div class="banner banner--hero">
  <hgroup class="container">
    <h1>Log in to Ionic</h1>
  </hgroup>
</div>
<main>
  <section class="tab-content" id="content-account">
    <div class="container">
      <div class="form-row">
        <div class="col form-wrapper">
          <form class="form" id="login-form" role="form">
            <div class="errorlist">
              <div>Unable to log in:</div>
              <div class="form-message"></div>
            </div>
            <div class="form-group" id="field-email">
              <label for="id_email">Email</label>
              <input type="text" id="id_email" name="email" autocomplete="username" tabindex="1" required>
              <div class="form-message form-message--small"></div>
            </div>
            <div class="form-group" id="field-password">
              <label for="id_password">
                Password
                <div class="forgot-password">
                  <a href="https://dashboard.ionicframework.com/reset-password" title="Reset Password?">Forgot password?</a>
                </div>
              </label>
              <input type="password" id="id_password" name="password" autocomplete="current-password" tabindex="2" required>
              <div class="form-message form-message--small"></div>
            </div>
            <button type="submit" id="submit" class="btn btn-block" tabindex="3">Log in</button>
            <div class="well">
              Don't have an account? <a class="text-link" href="https://dashboard.ionicframework.com/signup">Sign up</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block scripts %}
{# URLSearchParams polyfill #}
<script src="https://unpkg.com/core-js-bundle@3.6.0/minified.js" integrity="sha384-ncfanduqeM726N53pO1u/fzP/gCzfbFxS9jpeBFt14eSI91/PIYHX8c98k88DcTF" crossorigin="anonymous"></script>
<script>
  (function() {
    // handle login form submission
    document
      .getElementById("login-form")
      .addEventListener("submit", function(e) {
        e.preventDefault();
        var data = {
          email: document.getElementById("id_email").value,
          password: document.getElementById("id_password").value,
          source: "framework-login"
        };

        ajaxPost("/oauth/login", JSON.stringify(data), function(res, xhr) {
          if (xhr.status === 200) {
            window.c("Log in", "btn-login-submit");
            var _hsq = (window._hsq = window._hsq || []);
            _hsq.push(["identify", { email: data.email }]);
            _hsq.push(["trackEvent", { id: "000006636951" }]);

            var params = new URLSearchParams(location.search);
            if (!params.has('client_id')) {
              params.set('response_type', 'id_token token');
              params.set('scope', 'openid profile email');
              params.set('client_id', 'dash');
              params.set('nonce', Math.random().toString(36).substring(2));
            }

            window.location = "/oauth/authorize?" + params.toString();
          } else {
            var response;
            try {
              response = JSON.parse(res);
            } catch (e) {
              response = { error: { message: e } };
            }
            clearErrors();
            handleError(response.error);
          }
        });

        function ajaxPost(url, data, callback, x) {
          try {
            x = new (this.XMLHttpRequest || ActiveXObject)(
              "MSXML2.XMLHTTP.3.0"
            );
            x.open("POST", url, 1);
            x.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            x.setRequestHeader("Content-Type", "application/json");
            x.onreadystatechange = function() {
              x.readyState > 3 && callback && callback(x.responseText, x);
            };
            x.send(data);
          } catch (e) {
            window.console && console.log(e);
          }
        }

        function handleError(response) {
          var loginError = response;
          var loginErrors =
            loginError && loginError.details
              ? loginError.details.reduce(function(acc, current) {
                  acc[current.parameter] = current.errors.join(" ");
                  return acc;
                }, {})
              : {};

          if (loginError) {
            var errorlist = document.querySelector(".errorlist");
            var message = errorlist.querySelector(".form-message");
            errorlist.classList.add("error");
            message.innerHTML = loginError.message;
          }

          if (loginErrors) {
            for (var key in loginErrors) {
              var errorGroup = document.querySelector("#field-" + key);
              var message = errorGroup.querySelector(".form-message");
              errorGroup.classList.add("error");
              message.innerHTML = loginErrors[key];
            }
          }
        }

        function clearErrors() {
          var errorlist = document.querySelector(".errorlist");
          var message = errorlist.querySelector(".form-message");
          errorlist.classList.remove("error");
          message.innerHTML = "";

          var keys = ["email", "password"];
          for (var i = 0; i < keys.length; i++) {
            var errorGroup = document.querySelector("#field-" + keys[i]);
            var message = errorGroup.querySelector(".form-message");
            errorGroup.classList.remove("error");
            message.innerHTML = "";
          }
        }
      });
  })();
</script>
{% endblock %}
